<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flipkart Products (AJAX)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
    <style>
        .flipkart-logo {
            height: 50px;
            margin-right: 10px;
        }
        .header-flex {
            display: flex;
            align-items: center;
        }
    </style>
<body>
<div class="container mt-4">
    <h2>Flipkart Products (AJAX)</h2>
    <div class="header-flex mb-3">
        <img src="https://static-assets-web.flixcart.com/batman-returns/batman-returns/p/images/fk-explorePlus-c5de64.png" alt="Flipkart Logo" class="flipkart-logo">
        <h2>Flipkart Products (AJAX)</h2>
    </div>
    <form id="searchForm" class="form-inline mb-3">
        <input type="text" name="brand" id="brand" placeholder="Brand" class="form-control mr-2">
        <input type="text" name="title" id="title" placeholder="Title" class="form-control mr-2">
        <input type="number" name="min_price" id="min_price" placeholder="Min Price" class="form-control mr-2">
        <input type="number" name="max_price" id="max_price" placeholder="Max Price" class="form-control mr-2">
        <button type="submit" class="btn btn-primary mr-2">Search</button>
        <button type="button" id="downloadBtn" class="btn btn-success">Download CSV</button>
    </form>
    <div id="loading" style="display:none;">Loading...</div>
    <div id="error" class="alert alert-danger" style="display:none;"></div>
    <div class="table-responsive">
        <table class="table table-striped" id="productsTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
    <nav>
        <ul class="pagination" id="pagination"></ul>
    </nav>
</div>

<!-- Move script to end of body so it always runs -->
</div>
<script>
console.log('Script loaded');
let token = null;
function fetchProducts(page=1) {
    $('#loading').show();
    $('#error').hide();
    let params = {
        page: page,
        per_page: 10,
        brand: $('#brand').val(),
        title: $('#title').val(),
        min_price: $('#min_price').val(),
        max_price: $('#max_price').val()
    };
    $.ajax({
        url: '/api/products',
        method: 'GET',
        data: params,
        success: function(res) {
            console.log('API response:', res);
            $('#loading').hide();
            let products = res.products;
            let thead = '<tr>';
            if(products.length > 0) {
                Object.keys(products[0]).forEach(function(key) { thead += '<th>'+key+'</th>'; });
            }
            thead += '</tr>';
            $('#productsTable thead').html(thead);
            var tbody = '';
            if (products.length === 0) {
                tbody = '<tr><td colspan="100%" class="text-center">No products found.</td></tr>';
            } else {
                products.forEach(function(row) {
                    tbody += '<tr>';
                    Object.values(row).forEach(function(val) {
                        tbody += '<td>'+val+'</td>';
                    });
                    tbody += '</tr>';
                });
            }
            $('#productsTable tbody').html(tbody);
        },
        error: function(xhr, status, error) {
            console.log('AJAX error:', status, error, xhr.responseText);
            $('#loading').hide();
            $('#error').show().text('Error fetching data: ' + error);
        }
    });
}

$(document).ready(function() {
    fetchProducts(1);
    $('#searchForm').on('submit', function(e) {
        e.preventDefault();
        fetchProducts(1);
    });
    $('#downloadBtn').click(function() {
        window.location = '/api/products/download';
    });
});
</script>
</body>
</html>
    